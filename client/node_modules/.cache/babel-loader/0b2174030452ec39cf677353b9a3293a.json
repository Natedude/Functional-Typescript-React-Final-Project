{"ast":null,"code":"import { isNativeAudioNodeFaker } from '../guards/native-audio-node-faker';\nimport { isOwnedByContext } from '../helpers/is-owned-by-context';\nexport const createPannerNodeRendererFactory = (connectAudioParam, createNativeChannelMergerNode, createNativeConstantSourceNode, createNativeGainNode, createNativePannerNode, getNativeAudioNode, nativeOfflineAudioContextConstructor, renderAutomation, renderInputsOfAudioNode, renderNativeOfflineAudioContext) => {\n  return () => {\n    const renderedNativeAudioNodes = new WeakMap();\n    let renderedBufferPromise = null;\n\n    const createAudioNode = async (proxy, nativeOfflineAudioContext, trace) => {\n      let nativeGainNode = null;\n      let nativePannerNode = getNativeAudioNode(proxy);\n      const commonAudioNodeOptions = {\n        channelCount: nativePannerNode.channelCount,\n        channelCountMode: nativePannerNode.channelCountMode,\n        channelInterpretation: nativePannerNode.channelInterpretation\n      };\n      const commonNativePannerNodeOptions = { ...commonAudioNodeOptions,\n        coneInnerAngle: nativePannerNode.coneInnerAngle,\n        coneOuterAngle: nativePannerNode.coneOuterAngle,\n        coneOuterGain: nativePannerNode.coneOuterGain,\n        distanceModel: nativePannerNode.distanceModel,\n        maxDistance: nativePannerNode.maxDistance,\n        panningModel: nativePannerNode.panningModel,\n        refDistance: nativePannerNode.refDistance,\n        rolloffFactor: nativePannerNode.rolloffFactor\n      }; // If the initially used nativePannerNode was not constructed on the same OfflineAudioContext it needs to be created again.\n\n      const nativePannerNodeIsOwnedByContext = isOwnedByContext(nativePannerNode, nativeOfflineAudioContext); // Bug #124: Safari does not support modifying the orientation and the position with AudioParams.\n\n      if ('bufferSize' in nativePannerNode) {\n        nativeGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions,\n          gain: 1\n        });\n      } else if (!nativePannerNodeIsOwnedByContext) {\n        const options = { ...commonNativePannerNodeOptions,\n          orientationX: nativePannerNode.orientationX.value,\n          orientationY: nativePannerNode.orientationY.value,\n          orientationZ: nativePannerNode.orientationZ.value,\n          positionX: nativePannerNode.positionX.value,\n          positionY: nativePannerNode.positionY.value,\n          positionZ: nativePannerNode.positionZ.value\n        };\n        nativePannerNode = createNativePannerNode(nativeOfflineAudioContext, options);\n      }\n\n      renderedNativeAudioNodes.set(nativeOfflineAudioContext, nativeGainNode === null ? nativePannerNode : nativeGainNode);\n\n      if (nativeGainNode !== null) {\n        if (renderedBufferPromise === null) {\n          if (nativeOfflineAudioContextConstructor === null) {\n            throw new Error('Missing the native OfflineAudioContext constructor.');\n          }\n\n          const partialOfflineAudioContext = new nativeOfflineAudioContextConstructor(6, // Bug #17: Safari does not yet expose the length.\n          proxy.context.length, nativeOfflineAudioContext.sampleRate);\n          const nativeChannelMergerNode = createNativeChannelMergerNode(partialOfflineAudioContext, {\n            channelCount: 1,\n            channelCountMode: 'explicit',\n            channelInterpretation: 'speakers',\n            numberOfInputs: 6\n          });\n          nativeChannelMergerNode.connect(partialOfflineAudioContext.destination);\n\n          renderedBufferPromise = (async () => {\n            const nativeConstantSourceNodes = await Promise.all([proxy.orientationX, proxy.orientationY, proxy.orientationZ, proxy.positionX, proxy.positionY, proxy.positionZ].map(async (audioParam, index) => {\n              const nativeConstantSourceNode = createNativeConstantSourceNode(partialOfflineAudioContext, {\n                channelCount: 1,\n                channelCountMode: 'explicit',\n                channelInterpretation: 'discrete',\n                offset: index === 0 ? 1 : 0\n              });\n              await renderAutomation(partialOfflineAudioContext, audioParam, nativeConstantSourceNode.offset, trace);\n              return nativeConstantSourceNode;\n            }));\n\n            for (let i = 0; i < 6; i += 1) {\n              nativeConstantSourceNodes[i].connect(nativeChannelMergerNode, 0, i);\n              nativeConstantSourceNodes[i].start(0);\n            }\n\n            return renderNativeOfflineAudioContext(partialOfflineAudioContext);\n          })();\n        }\n\n        const renderedBuffer = await renderedBufferPromise;\n        const inputGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions,\n          gain: 1\n        });\n        await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, inputGainNode, trace);\n        const channelDatas = [];\n\n        for (let i = 0; i < renderedBuffer.numberOfChannels; i += 1) {\n          channelDatas.push(renderedBuffer.getChannelData(i));\n        }\n\n        let lastOrientation = [channelDatas[0][0], channelDatas[1][0], channelDatas[2][0]];\n        let lastPosition = [channelDatas[3][0], channelDatas[4][0], channelDatas[5][0]];\n        let gateGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions,\n          gain: 1\n        });\n        let partialPannerNode = createNativePannerNode(nativeOfflineAudioContext, { ...commonNativePannerNodeOptions,\n          orientationX: lastOrientation[0],\n          orientationY: lastOrientation[1],\n          orientationZ: lastOrientation[2],\n          positionX: lastPosition[0],\n          positionY: lastPosition[1],\n          positionZ: lastPosition[2]\n        });\n        inputGainNode.connect(gateGainNode).connect(partialPannerNode.inputs[0]);\n        partialPannerNode.connect(nativeGainNode);\n\n        for (let i = 128; i < renderedBuffer.length; i += 128) {\n          const orientation = [channelDatas[0][i], channelDatas[1][i], channelDatas[2][i]];\n          const positon = [channelDatas[3][i], channelDatas[4][i], channelDatas[5][i]];\n\n          if (orientation.some((value, index) => value !== lastOrientation[index]) || positon.some((value, index) => value !== lastPosition[index])) {\n            lastOrientation = orientation;\n            lastPosition = positon;\n            const currentTime = i / nativeOfflineAudioContext.sampleRate;\n            gateGainNode.gain.setValueAtTime(0, currentTime);\n            gateGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions,\n              gain: 0\n            });\n            partialPannerNode = createNativePannerNode(nativeOfflineAudioContext, { ...commonNativePannerNodeOptions,\n              orientationX: lastOrientation[0],\n              orientationY: lastOrientation[1],\n              orientationZ: lastOrientation[2],\n              positionX: lastPosition[0],\n              positionY: lastPosition[1],\n              positionZ: lastPosition[2]\n            });\n            gateGainNode.gain.setValueAtTime(1, currentTime);\n            inputGainNode.connect(gateGainNode).connect(partialPannerNode.inputs[0]);\n            partialPannerNode.connect(nativeGainNode);\n          }\n        }\n\n        return nativeGainNode;\n      }\n\n      if (!nativePannerNodeIsOwnedByContext) {\n        await renderAutomation(nativeOfflineAudioContext, proxy.orientationX, nativePannerNode.orientationX, trace);\n        await renderAutomation(nativeOfflineAudioContext, proxy.orientationY, nativePannerNode.orientationY, trace);\n        await renderAutomation(nativeOfflineAudioContext, proxy.orientationZ, nativePannerNode.orientationZ, trace);\n        await renderAutomation(nativeOfflineAudioContext, proxy.positionX, nativePannerNode.positionX, trace);\n        await renderAutomation(nativeOfflineAudioContext, proxy.positionY, nativePannerNode.positionY, trace);\n        await renderAutomation(nativeOfflineAudioContext, proxy.positionZ, nativePannerNode.positionZ, trace);\n      } else {\n        await connectAudioParam(nativeOfflineAudioContext, proxy.orientationX, nativePannerNode.orientationX, trace);\n        await connectAudioParam(nativeOfflineAudioContext, proxy.orientationY, nativePannerNode.orientationY, trace);\n        await connectAudioParam(nativeOfflineAudioContext, proxy.orientationZ, nativePannerNode.orientationZ, trace);\n        await connectAudioParam(nativeOfflineAudioContext, proxy.positionX, nativePannerNode.positionX, trace);\n        await connectAudioParam(nativeOfflineAudioContext, proxy.positionY, nativePannerNode.positionY, trace);\n        await connectAudioParam(nativeOfflineAudioContext, proxy.positionZ, nativePannerNode.positionZ, trace);\n      }\n\n      if (isNativeAudioNodeFaker(nativePannerNode)) {\n        await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, nativePannerNode.inputs[0], trace);\n      } else {\n        await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, nativePannerNode, trace);\n      }\n\n      return nativePannerNode;\n    };\n\n    return {\n      render(proxy, nativeOfflineAudioContext, trace) {\n        const renderedNativeGainNodeOrNativePannerNode = renderedNativeAudioNodes.get(nativeOfflineAudioContext);\n\n        if (renderedNativeGainNodeOrNativePannerNode !== undefined) {\n          return Promise.resolve(renderedNativeGainNodeOrNativePannerNode);\n        }\n\n        return createAudioNode(proxy, nativeOfflineAudioContext, trace);\n      }\n\n    };\n  };\n};","map":{"version":3,"sources":["../../../src/factories/panner-node-renderer-factory.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { isNativeAudioNodeFaker } from '../guards/native-audio-node-faker';\nimport { isOwnedByContext } from '../helpers/is-owned-by-context';\nexport const createPannerNodeRendererFactory = (connectAudioParam, createNativeChannelMergerNode, createNativeConstantSourceNode, createNativeGainNode, createNativePannerNode, getNativeAudioNode, nativeOfflineAudioContextConstructor, renderAutomation, renderInputsOfAudioNode, renderNativeOfflineAudioContext) => {\n    return () => {\n        const renderedNativeAudioNodes = new WeakMap();\n        let renderedBufferPromise = null;\n        const createAudioNode = async (proxy, nativeOfflineAudioContext, trace) => {\n            let nativeGainNode = null;\n            let nativePannerNode = getNativeAudioNode(proxy);\n            const commonAudioNodeOptions = {\n                channelCount: nativePannerNode.channelCount,\n                channelCountMode: nativePannerNode.channelCountMode,\n                channelInterpretation: nativePannerNode.channelInterpretation\n            };\n            const commonNativePannerNodeOptions = {\n                ...commonAudioNodeOptions,\n                coneInnerAngle: nativePannerNode.coneInnerAngle,\n                coneOuterAngle: nativePannerNode.coneOuterAngle,\n                coneOuterGain: nativePannerNode.coneOuterGain,\n                distanceModel: nativePannerNode.distanceModel,\n                maxDistance: nativePannerNode.maxDistance,\n                panningModel: nativePannerNode.panningModel,\n                refDistance: nativePannerNode.refDistance,\n                rolloffFactor: nativePannerNode.rolloffFactor\n            };\n            // If the initially used nativePannerNode was not constructed on the same OfflineAudioContext it needs to be created again.\n            const nativePannerNodeIsOwnedByContext = isOwnedByContext(nativePannerNode, nativeOfflineAudioContext);\n            // Bug #124: Safari does not support modifying the orientation and the position with AudioParams.\n            if ('bufferSize' in nativePannerNode) {\n                nativeGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions, gain: 1 });\n            }\n            else if (!nativePannerNodeIsOwnedByContext) {\n                const options = {\n                    ...commonNativePannerNodeOptions,\n                    orientationX: nativePannerNode.orientationX.value,\n                    orientationY: nativePannerNode.orientationY.value,\n                    orientationZ: nativePannerNode.orientationZ.value,\n                    positionX: nativePannerNode.positionX.value,\n                    positionY: nativePannerNode.positionY.value,\n                    positionZ: nativePannerNode.positionZ.value\n                };\n                nativePannerNode = createNativePannerNode(nativeOfflineAudioContext, options);\n            }\n            renderedNativeAudioNodes.set(nativeOfflineAudioContext, nativeGainNode === null ? nativePannerNode : nativeGainNode);\n            if (nativeGainNode !== null) {\n                if (renderedBufferPromise === null) {\n                    if (nativeOfflineAudioContextConstructor === null) {\n                        throw new Error('Missing the native OfflineAudioContext constructor.');\n                    }\n                    const partialOfflineAudioContext = new nativeOfflineAudioContextConstructor(6, \n                    // Bug #17: Safari does not yet expose the length.\n                    proxy.context.length, nativeOfflineAudioContext.sampleRate);\n                    const nativeChannelMergerNode = createNativeChannelMergerNode(partialOfflineAudioContext, {\n                        channelCount: 1,\n                        channelCountMode: 'explicit',\n                        channelInterpretation: 'speakers',\n                        numberOfInputs: 6\n                    });\n                    nativeChannelMergerNode.connect(partialOfflineAudioContext.destination);\n                    renderedBufferPromise = (async () => {\n                        const nativeConstantSourceNodes = await Promise.all([\n                            proxy.orientationX,\n                            proxy.orientationY,\n                            proxy.orientationZ,\n                            proxy.positionX,\n                            proxy.positionY,\n                            proxy.positionZ\n                        ].map(async (audioParam, index) => {\n                            const nativeConstantSourceNode = createNativeConstantSourceNode(partialOfflineAudioContext, {\n                                channelCount: 1,\n                                channelCountMode: 'explicit',\n                                channelInterpretation: 'discrete',\n                                offset: index === 0 ? 1 : 0\n                            });\n                            await renderAutomation(partialOfflineAudioContext, audioParam, nativeConstantSourceNode.offset, trace);\n                            return nativeConstantSourceNode;\n                        }));\n                        for (let i = 0; i < 6; i += 1) {\n                            nativeConstantSourceNodes[i].connect(nativeChannelMergerNode, 0, i);\n                            nativeConstantSourceNodes[i].start(0);\n                        }\n                        return renderNativeOfflineAudioContext(partialOfflineAudioContext);\n                    })();\n                }\n                const renderedBuffer = await renderedBufferPromise;\n                const inputGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions, gain: 1 });\n                await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, inputGainNode, trace);\n                const channelDatas = [];\n                for (let i = 0; i < renderedBuffer.numberOfChannels; i += 1) {\n                    channelDatas.push(renderedBuffer.getChannelData(i));\n                }\n                let lastOrientation = [channelDatas[0][0], channelDatas[1][0], channelDatas[2][0]];\n                let lastPosition = [channelDatas[3][0], channelDatas[4][0], channelDatas[5][0]];\n                let gateGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions, gain: 1 });\n                let partialPannerNode = createNativePannerNode(nativeOfflineAudioContext, {\n                    ...commonNativePannerNodeOptions,\n                    orientationX: lastOrientation[0],\n                    orientationY: lastOrientation[1],\n                    orientationZ: lastOrientation[2],\n                    positionX: lastPosition[0],\n                    positionY: lastPosition[1],\n                    positionZ: lastPosition[2]\n                });\n                inputGainNode.connect(gateGainNode).connect(partialPannerNode.inputs[0]);\n                partialPannerNode.connect(nativeGainNode);\n                for (let i = 128; i < renderedBuffer.length; i += 128) {\n                    const orientation = [channelDatas[0][i], channelDatas[1][i], channelDatas[2][i]];\n                    const positon = [channelDatas[3][i], channelDatas[4][i], channelDatas[5][i]];\n                    if (orientation.some((value, index) => value !== lastOrientation[index]) ||\n                        positon.some((value, index) => value !== lastPosition[index])) {\n                        lastOrientation = orientation;\n                        lastPosition = positon;\n                        const currentTime = i / nativeOfflineAudioContext.sampleRate;\n                        gateGainNode.gain.setValueAtTime(0, currentTime);\n                        gateGainNode = createNativeGainNode(nativeOfflineAudioContext, { ...commonAudioNodeOptions, gain: 0 });\n                        partialPannerNode = createNativePannerNode(nativeOfflineAudioContext, {\n                            ...commonNativePannerNodeOptions,\n                            orientationX: lastOrientation[0],\n                            orientationY: lastOrientation[1],\n                            orientationZ: lastOrientation[2],\n                            positionX: lastPosition[0],\n                            positionY: lastPosition[1],\n                            positionZ: lastPosition[2]\n                        });\n                        gateGainNode.gain.setValueAtTime(1, currentTime);\n                        inputGainNode.connect(gateGainNode).connect(partialPannerNode.inputs[0]);\n                        partialPannerNode.connect(nativeGainNode);\n                    }\n                }\n                return nativeGainNode;\n            }\n            if (!nativePannerNodeIsOwnedByContext) {\n                await renderAutomation(nativeOfflineAudioContext, proxy.orientationX, nativePannerNode.orientationX, trace);\n                await renderAutomation(nativeOfflineAudioContext, proxy.orientationY, nativePannerNode.orientationY, trace);\n                await renderAutomation(nativeOfflineAudioContext, proxy.orientationZ, nativePannerNode.orientationZ, trace);\n                await renderAutomation(nativeOfflineAudioContext, proxy.positionX, nativePannerNode.positionX, trace);\n                await renderAutomation(nativeOfflineAudioContext, proxy.positionY, nativePannerNode.positionY, trace);\n                await renderAutomation(nativeOfflineAudioContext, proxy.positionZ, nativePannerNode.positionZ, trace);\n            }\n            else {\n                await connectAudioParam(nativeOfflineAudioContext, proxy.orientationX, nativePannerNode.orientationX, trace);\n                await connectAudioParam(nativeOfflineAudioContext, proxy.orientationY, nativePannerNode.orientationY, trace);\n                await connectAudioParam(nativeOfflineAudioContext, proxy.orientationZ, nativePannerNode.orientationZ, trace);\n                await connectAudioParam(nativeOfflineAudioContext, proxy.positionX, nativePannerNode.positionX, trace);\n                await connectAudioParam(nativeOfflineAudioContext, proxy.positionY, nativePannerNode.positionY, trace);\n                await connectAudioParam(nativeOfflineAudioContext, proxy.positionZ, nativePannerNode.positionZ, trace);\n            }\n            if (isNativeAudioNodeFaker(nativePannerNode)) {\n                await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, nativePannerNode.inputs[0], trace);\n            }\n            else {\n                await renderInputsOfAudioNode(proxy, nativeOfflineAudioContext, nativePannerNode, trace);\n            }\n            return nativePannerNode;\n        };\n        return {\n            render(proxy, nativeOfflineAudioContext, trace) {\n                const renderedNativeGainNodeOrNativePannerNode = renderedNativeAudioNodes.get(nativeOfflineAudioContext);\n                if (renderedNativeGainNodeOrNativePannerNode !== undefined) {\n                    return Promise.resolve(renderedNativeGainNodeOrNativePannerNode);\n                }\n                return createAudioNode(proxy, nativeOfflineAudioContext, trace);\n            }\n        };\n    };\n};\n//# sourceMappingURL=panner-node-renderer-factory.js.map"]},"metadata":{},"sourceType":"module"}